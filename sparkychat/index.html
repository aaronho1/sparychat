<!DOCTYPE html>
<html lang="en">
<head>
	<title>SparkyChat!</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<style>
		html, body {
			height: 100%;
			display: flex;
			flex-direction: column;
		}

		.fillHeight {
			height: 100%;
		}

		.sizeOuterBoxTyping {
			height: calc(100vh - 120px);
		}

		.sizeOuterBoxNotTyping {
			height: calc(100vh - 85px);
		}

		.loginBox {
			width: 150px;
		}

		.chatInputFocused {
			height: 60px;
		}

		.chatInputUnfocused {
			height: 25px;
		}

		.card {
			position: absolute;
			top: 0px;
			right: 0px;
			overflow: hidden;
			width: 100%;
			height: 100%;
			overflow-x: hidden;
			
		}
	</style>

	<script>
		var checkMessagesFlag = false;
		var checkMessagesTimer;

		function showChat() {
			$('#loginBox').hide();
			$('#chatBox').css('visibility', 'visible');
			$('#chatInput').css('visibility', 'visible');
		}

		function scrollChat() {
			$("#chatPanel").scrollTop($("#chatPanel").prop("scrollHeight"));
		}

		function LogOn(userId, pass) {
			var webMethod = "sparkychatservices.asmx/LogOn";
			var parameters = "{\"uid\":\"" + encodeURI(userId) + "\",\"pass\":\"" + encodeURI(pass) + "\"}";

			$.ajax({
				type: "POST",
				url: webMethod,
				data: parameters,
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function (msg) {
					if (msg.d) {
						showChat();
						checkMessagesFlag = true;
						CheckMessages();
					}
					else {
						alert("logon failed");
					}
				},
				error: function (e) {
					alert("boo...");
				}
			});
		}

		function SendMessage(message) {
			var webMethod = "sparkychatservices.asmx/SendMessage";
			var parameters = "{\"message\":\"" + encodeURI(message) + "\"}";

			$.ajax({
				type: "POST",
				url: webMethod,
				data: parameters,
				contentType: "application/json; charset=utf-8",
				dataType: "json",
				success: function (msg) {
					if (msg.d) {
						$('#chatText').val('');
						checkMessagesFlag = false;
						clearTimeout(checkMessagesTimer);
						CheckMessages(true);
					}
					else {
						alert("send failed");
					}
				},
				error: function (e) {
					alert("boo...");
				}
			});
		}

		function CheckMessages(resetFlag) {
			resetFlag = resetFlag || false;
			if (resetFlag) {
				checkMessagesFlag = true;
			}
			if (checkMessagesFlag) {
				//alert("checking");
				var webMethod = "sparkychatservices.asmx/GetMessages";
				//var parameters = "{}";

				$.ajax({
					type: "POST",
					url: webMethod,
					//data: parameters,
					contentType: "application/json; charset=utf-8",
					dataType: "json",
					success: function (msg) {
						if (msg.d.length > 0) {
							for (var i = 0; i < msg.d.length; i++) {
								$("#chatPanel").append(
									"<div class='msg' id='msg" + msg.d[i].id + "'>" +
									"<span class='nameTag'>" +
									msg.d[i].userName +
									":</span> <span class='msgTag'>" +
									msg.d[i].message +
									"</span></div>"
								);
							}
						}

						scrollChat();
						if (checkMessagesFlag) {
							checkMessagesTimer = setTimeout(function () { CheckMessages() }, 5000);
						}
					},
					error: function (e) {
						alert("boo...");
					}
				});
			}
		}

		var txtFocus = false;

		jQuery(function () {

			$("#chatText").focus(function () {
				//alert('in');
				
				$("#chatInput").removeClass("chatInputUnfocused");
				$("#chatInput").addClass("chatInputFocused");
				/*
				$("#chatBox").removeClass("sizeOuterBoxNotTyping");
				$("#chatBox").addClass("sizeOuterBoxTyping");
				//setTimeout(function () { $("#chatBox").css('height', (window.innerHeight - 120) + "px"); }, 50);
				txtFocus = true;
				*/
				scrollChat();
				
			});

			$("#chatText").focusout(function () {
				//alert('out');
				$("#chatInput").addClass("chatInputUnfocused");
				$("#chatInput").removeClass("chatInputFocused");
				/*
				$("#chatBox").addClass("sizeOuterBoxNotTyping");
				$("#chatBox").css('height', (window.innerHeight - 85) + "px");
				$("#chatBox").removeClass("sizeOuterBoxTyping");
				txtFocus = false;
				*/
				scrollChat();
				
			});

			/*
			$("#window").resize(function () {
				if (txtFocus) {
					$("#chatBox").css('height', (window.innerHeight - 120) + "px");
				}
			});
			*/


			$("#chatText").on("keypress", function (e) {
				if (e.keyCode == 13) {
					SendMessage($("#chatText").val());
				}
			});
		});
	</script>

</head>
<body>

	<nav class="navbar navbar-inverse">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">SparkyChat!</a>
			</div>
			<div class="collapse navbar-collapse" id="myNavbar">
				<ul class="nav navbar-nav navbar-right">
					<li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
					<li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div id="cardHolder" style="flex: 1; position: relative;">
		<div id="loginBox" class="container-fluid card">
			<div class="row-fluid">
				<div class="col-xs-4">
					User ID:
				</div>
				<div class="col-xs-8">
					<input class="loginBox" type="text" id="uid" />
				</div>
			</div>
			<div class="row-fluid">
				<div class="col-xs-4">
					Password:
				</div>
				<div class="col-xs-8">
					<input class="loginBox" type="password" id="pass" />
				</div>
			</div>
			<div class="row-fluid">
				<div class="col-xs-4 col-xs-offset-8">
					<a onclick="LogOn($('#uid').val(), $('#pass').val())">Log On</a>
				</div>
			</div>
		</div>




		<div class="container-fluid card" style="visibility:hidden; display:flex; flex-direction:column;">
			<div id="chatBox" class="row-fluid" style="flex: 1;">
				<div class="col-xs-12" style="height:100%;">
					<div class="panel panel-default" style="height:100%;">
						<div id="chatPanel" class="panel-body" style="overflow-y: scroll; height:100%;"></div>
					</div>
				</div>
			</div>
			<div class="row-fluid">
				<div id="chatInput" class="chatInputUnfocused col-xs-12" style="overflow:hidden;">
					<textarea id="chatText" style="width:100%; height:100%; overflow:hidden" placeholder="Type your message here..."></textarea>
				</div>
			</div>
		</div>
	</div>
</body>
</html>